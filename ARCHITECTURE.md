# 数据库安全实验环境架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           数据库安全实验环境                                      │
│                      (Docker Compose Network: bridge)                            │
└─────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────┐
│  模块一: 攻击与检测实验                                                           │
│  目标: 测试 SQL 注入攻击及 WAF/IDS 检测效果                                       │
└──────────────────────────────────────────────────────────────────────────────────┘

                      ┌─────────────────┐
                      │ attack-client   │ (攻击模拟器)
                      │ - SQLMap        │
                      │ - Hydra         │
                      │ - 自定义脚本     │
                      └────────┬────────┘
                               │ HTTP 请求
                               │ (SQL 注入、暴力破解)
                               ↓
                      ┌─────────────────┐
                      │  modsecurity    │ ← WAF (Web Application Firewall)
                      │   (OWASP CRS)   │    - 规则匹配
                      │  Port: 8081     │    - 写入审计日志
                      └────────┬────────┘
                               │ 监听流量
                               ├──────────────────────────┐
                               │                          │
                               ↓                          ↓
                      ┌─────────────────┐       ┌────────────────┐
                      │    suricata     │       │   vuln-api     │ (漏洞后端)
                      │ (IDS 入侵检测)   │       │   Flask App    │
                      │ - SQL注入规则    │       │   Port: 8081   │
                      │ - 写入 eve.json  │       └────────┬───────┘
                      └─────────────────┘                 │
                                                          │ 数据库查询
                               ┌──────────────────────────┼──────────────────┐
                               ↓                          ↓                  ↓
                      ┌─────────────────┐       ┌─────────────────┐  ┌──────────────┐
                      │   juiceshop     │       │  postgres-db    │  │   mongo-db   │
                      │  (漏洞靶场)      │       │  Port: 5433     │  │  Port: 27018 │
                      │  Port: 3001     │       │  (攻击目标)     │  │  (NoSQL注入) │
                      └─────────────────┘       └─────────────────┘  └──────────────┘


┌──────────────────────────────────────────────────────────────────────────────────┐
│  模块二: 数据加密性能对比实验                                                      │
│  目标: 对比透明加密代理 (Acra) vs 应用层加密 (pgcrypto) 性能                      │
└──────────────────────────────────────────────────────────────────────────────────┘

                      ┌─────────────────────────────────────┐
                      │         attack-client               │
                      │    (性能测试脚本运行环境)            │
                      │  benchmark_encryption.py            │
                      └──────┬────────────┬─────────────┬───┘
                             │            │             │
                        ┌────┘            │             └────┐
                        │                 │                  │
                        ↓                 ↓                  ↓
              ┌──────────────────┐  ┌─────────────┐  ┌──────────────────┐
              │  postgres-db     │  │ acra-server │  │postgres-pgcrypto │
              │   (Baseline)     │  │   透明代理   │  │ (应用层加密)      │
              │  Port: 5433      │  │ Port: 9393  │  │  Port: 5435      │
              │  未加密基准测试   │  └──────┬──────┘  │  pgcrypto 扩展   │
              └──────────────────┘         │         └──────────────────┘
                                           │ PostgreSQL 协议
                                           │ (拦截并加密)
                                           ↓
                                  ┌─────────────────┐
                                  │ postgres-acra   │
                                  │  (加密数据库)    │
                                  │  Port: 5434     │
                                  │  AES-256-GCM    │
                                  └─────────────────┘
                                           ↑
                                           │ 密钥加载
                                  ┌────────┴────────┐
                                  │  acra-keymaker  │
                                  │  (密钥生成工具)  │
                                  │  初始化后退出    │
                                  └─────────────────┘


┌──────────────────────────────────────────────────────────────────────────────────┐
│  已禁用服务 (测试失败)                                                            │
└──────────────────────────────────────────────────────────────────────────────────┘

                      ┌─────────────────────────┐
                      │  cipherstash-proxy      │ ✗ 协议不兼容
                      │  Port: 7432             │
                      └────────┬────────────────┘
                               │
                               ↓
                      ┌─────────────────────────┐
                      │ postgres-cipherstash    │ ✗ 配置表无法填充
                      │  Port: 5436             │
                      └─────────────────────────┘
```

## 详细架构说明

### 模块一: 攻击与检测链路

```
攻击流程:
┌──────────┐   ①恶意请求    ┌──────────┐   ②规则检测   ┌──────────┐
│ attack-  │ ──────────→   │  ModSec  │ ──────────→  │  vuln-   │
│ client   │               │   WAF    │               │   api    │
└──────────┘               └────┬─────┘               └────┬─────┘
                                │                          │
                         ③流量镜像                    ④数据库查询
                                │                          │
                                ↓                          ↓
                         ┌─────────┐               ┌─────────────┐
                         │Suricata │               │postgres/mongo│
                         │  IDS    │               │     DB      │
                         └─────────┘               └─────────────┘
                                │                          │
                         ⑤写入eve.json              ⑥返回查询结果
                                ↓                          ↓
                         results/suricata/         (正常/异常响应)
```

**关键点**:
1. **ModSecurity (WAF)**: 
   - 作为反向代理拦截所有 HTTP 请求
   - 应用 OWASP CRS 规则检测 SQL 注入
   - 记录到 `/var/log/modsecurity/audit.log`

2. **Suricata (IDS)**: 
   - 使用 `network_mode: "service:modsecurity"` 共享网络栈
   - 监听 `eth0` 接口捕获所有流量
   - 自定义 SQL 注入检测规则
   - 输出到 `results/suricata/eve.json`

3. **vuln-api**: 
   - 故意存在 SQL 注入漏洞的 Flask 应用
   - 连接 postgres-db 和 mongo-db

### 模块二: 加密性能测试架构

```
性能测试对比:

方案 A - Baseline (无加密)
┌──────────┐  直接连接  ┌──────────┐
│benchmark │ ────────→ │postgres- │
│ script   │  5433端口  │   db     │
└──────────┘           └──────────┘

方案 B - Acra 透明代理
┌──────────┐  ①客户端   ┌──────────┐  ②代理转发  ┌──────────┐
│benchmark │ ────────→ │  acra-   │ ────────→  │postgres- │
│ script   │  9393端口  │  server  │    5432     │  acra    │
└──────────┘           └────┬─────┘             └──────────┘
                            │
                       ③加密/解密
                       (AES-256-GCM)
                            │
                       ┌────┴─────┐
                       │ 密钥存储  │
                       │acra_keys/│
                       └──────────┘

方案 C - pgcrypto 应用层加密
┌──────────┐  SQL + 加密函数  ┌──────────┐
│benchmark │ ──────────────→ │postgres- │
│ script   │   5435端口       │pgcrypto  │
│          │ pgp_sym_encrypt  └──────────┘
└──────────┘ pgp_sym_decrypt   ↑ 内置 pgcrypto 扩展
```

**关键差异**:

| 特性 | Baseline | Acra | pgcrypto |
|------|----------|------|----------|
| **透明度** | N/A | 完全透明 | 需修改 SQL |
| **加密位置** | 无 | 代理层 | 数据库内 |
| **应用改造** | N/A | 零改造 | 调用加密函数 |
| **密钥管理** | N/A | 外部密钥文件 | 传入参数 |

## 网络端口映射

| 服务 | 容器内端口 | 主机端口 | 协议 | 用途 |
|------|-----------|---------|------|------|
| juiceshop | 3000 | 3001 | HTTP | Web UI |
| postgres-db | 5432 | 5433 | PostgreSQL | 基准数据库 |
| postgres-acra | 5432 | 5434 | PostgreSQL | Acra 后端 |
| acra-server | 9393 | 9393 | PostgreSQL | 加密代理 |
| postgres-pgcrypto | 5432 | 5435 | PostgreSQL | pgcrypto 扩展 |
| mongo-db | 27017 | 27018 | MongoDB | NoSQL 数据库 |
| vuln-api | 8081 | (内部) | HTTP | 漏洞后端 |
| modsecurity | 8080 | 8081 | HTTP | WAF 入口 |

## 容器依赖关系

```
启动顺序依赖 (depends_on):

postgres-acra
    ↓
acra-keymaker (生成密钥后退出)
    ↓
acra-server

postgres-db, mongo-db
    ↓
vuln-api
    ↓
modsecurity
    ↓
suricata

所有服务
    ↓
attack-client (最后启动，可访问所有服务)
```

## 数据卷 (Volumes)

```
持久化存储:
- postgres_acra_data:      Acra 数据库数据
- postgres_pgcrypto_data:  pgcrypto 数据库数据
- postgres_cipherstash_data: (已禁用)

宿主机挂载:
- ./acra_keys → /keys           (密钥文件)
- ./results/modsecurity → /var/log/modsecurity (WAF 日志)
- ./results/suricata → /var/log/suricata (IDS 日志)
- ./init-pgcrypto.sql → /docker-entrypoint-initdb.d/ (初始化)
```

## 资源配额

| 服务类型 | CPU 限制 | 内存限制 | 内存预留 |
|---------|---------|---------|---------|
| 数据库 & 靶场 | 4 vCPU | 8 GB | 6 GB |
| 代理 & 工具 | 2 vCPU | 4 GB | 2 GB |
| 攻击客户端 | 4 vCPU | 8 GB | 6 GB |

## 安全能力 (Capabilities)

```
attack-client & suricata:
  cap_add:
    - NET_ADMIN  (网络管理权限)
    - NET_RAW    (原始套接字权限)

用途: 
- 网络流量捕获 (tcpdump, Suricata)
- 攻击模拟 (原始数据包构造)
```

## 实验数据流

### 攻击检测实验
```
attack-client 生成攻击
    ↓
ModSecurity 拦截 + Suricata 监听
    ↓
日志写入 results/
    ↓
detect_metrics.py 分析
    ↓
生成 attack_detection_metrics.csv
```

### 加密性能实验
```
benchmark_encryption.py 执行
    ↓
连接 3 个数据库环境 (baseline, acra, pgcrypto)
    ↓
执行 500 次操作 (写入/读取/搜索)
    ↓
docker stats 采样 CPU
    ↓
生成 encryption_benchmark.csv
```

## 实验测试过程

本实验的测试过程包括四个步骤: 测试环境准备, 容器化系统构建, 测试执行和结果分析.

### 实验流程图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          数据库安全实验测试流程                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  步骤一: 测试环境准备                                                        ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
         │
         │  ① 安装 Docker & Docker Compose
         │  ② 下载实验代码仓库
         │  ③ 配置环境依赖
         │     
         ↓
    ┌─────────────────────────────────────────────────────────┐
    │  构建容器镜像                                            │
    │  ─────────────────────────────────────────────────────  │
    │  • ModSecurity WAF (Nginx + OWASP CRS)                  │
    │  • Suricata IDS (SQL 注入规则集)                         │
    │  • Attack Client (SQLMap + Hydra + 自定义脚本)           │
    │                                                          │
    │  Command: docker compose build                          │
    └─────────────────────────────────────────────────────────┘
         │
         ↓

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  步骤二: 容器化系统构建                                                      ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
         │
         │  定义 10 个服务容器
         ↓
    ┌──────────────────────────────────────────────────────────────────┐
    │  数据库层 (4 个容器)          防御层 (2 个容器)                   │
    │  ─────────────────────        ─────────────────                  │
    │  • postgres-db (baseline)     • modsecurity (WAF)                │
    │  • postgres-acra (encrypted)  • suricata (IDS)                   │
    │  • postgres-pgcrypto                                             │
    │  • mongo-db                                                      │
    │                                                                  │
    │  应用层 (2 个容器)            代理层 (1 个容器)                   │
    │  ─────────────────────        ─────────────────                  │
    │  • juiceshop (靶场)           • acra-server (加密代理)            │
    │  • vuln-api (漏洞后端)                                           │
    │                                                                  │
    │  测试层 (1 个容器)                                                │
    │  ─────────────────────                                           │
    │  • attack-client (攻击模拟器)                                     │
    └──────────────────────────────────────────────────────────────────┘
         │
         │  ① 配置 depends_on 依赖关系
         │  ② 分配资源配额 (4 vCPU/8GB 或 2 vCPU/4GB)
         │  ③ 设置端口映射 (5433, 5434, 5435, 8081, 9393...)
         │
         ↓
    ┌─────────────────────────────────────────────────────────┐
    │  Command: docker compose up -d                          │
    │  → 启动所有容器, 形成测试网络拓扑                         │
    └─────────────────────────────────────────────────────────┘
         │
         ↓

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  步骤三: 测试执行                                                            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
         │
         ├──────────────────────────────┬───────────────────────────────┐
         │                              │                               │
         ↓                              ↓                               ↓
  ┌──────────────┐              ┌──────────────┐              ┌────────────────┐
  │ 攻击检测测试  │              │ 加密性能测试  │              │ 预测试验证     │
  └──────────────┘              └──────────────┘              └────────────────┘
         │                              │                               │
         │                              │                               │
    【预测试】                      【环境连接】                      attack-client
         │                              │                               ↓
         ↓                              ↓                          ModSecurity
  attack-client                  baseline: 5433                        ↓
       ↓                         acra-server: 9393                 vuln-api
  ModSecurity (8081)             pgcrypto: 5435                        ↓
       ↓                              │                          Suricata 监听
  vuln-api                            │                               │
       ↓                              │                               │
  Suricata 监听                       ↓                          [通过] 或 [失败]
       │                        【执行操作】                            │
       │                              │                               │
  [通过] 或 [失败] ←──────────────────┘                          [失败] → 返回步骤二
       │                              │                               
       │                              │                               
  [失败] → 返回步骤二                 ↓                               
       │                        对每个环境:                            
       │                        • 500 次写入                           
       ↓                        • 500 次标准读取                       
  【正式测试】                    • 500 次可搜索查询                     
       │                              │                               
       ↓                              │                               
  automate_attacks.py                 ↓                               
       │                        【采样监控】                            
       │                              │                               
       ↓                              ↓                               
  三类 SQL 注入:                 • CPU 利用率 (0.3s 间隔)              
  • 基础注入 (150 恶意 + 150 正常)  • 响应延迟记录                      
  • 混淆注入 (150 恶意 + 150 正常)  • 缓存清空 (每环境前)               
  • 存储过程 (150 恶意 + 150 正常)                                     
       │                              │                               
  Hydra 暴力破解                      │                               
       │                              │                               
       ↓                              ↓                               
  【日志收集】                    【数据记录】                           
       │                              │                               
  ModSecurity 审计日志           延迟数据 (ms)                         
  Suricata eve.json              CPU 数据 (%)                         
       │                              │                               
       └──────────────────────────────┴───────────────────────────────┘
                                      │
                                      ↓

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  步骤四: 结果分析                                                            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
         │
         ├──────────────────────────────┬───────────────────────────────┐
         │                              │                               │
         ↓                              ↓                               ↓
  ┌───────────────┐            ┌───────────────┐              ┌─────────────────┐
  │攻击检测分析   │            │加密性能分析   │              │报告生成         │
  └───────────────┘            └───────────────┘              └─────────────────┘
         │                              │                               │
         ↓                              ↓                               │
  【统计指标】                      【计算指标】                           │
         │                              │                               │
    收集日志                        收集数据                             │
         ↓                              ↓                               │
    TP (真阳性)                     延迟数据                             │
    FN (假阴性)                     CPU 数据                             │
    FP (假阳性)                          ↓                               │
    TN (真阴性)                     计算平均值                           │
         ↓                         过滤异常值                           │
    计算 TPR                             ↓                               │
    TPR = TP/(TP+FN)                延迟开销 %                           │
         ↓                         CPU 开销 %                           │
    计算 FPR                             ↓                               │
    FPR = FP/(FP+TN)                验证完整性                           │
         │                         (100% 采样)                          │
         ↓                              │                               │
  【去重分析】                      【对比分析】                           │
         │                              │                               │
    自动化去重                      Baseline vs Acra                     │
         ↓                         Baseline vs pgcrypto                 │
    人工分析                             ↓                               │
         ↓                         写入性能对比                          │
    分类统计                        读取性能对比                          │
    • 基础 SQL 注入                 可搜索查询对比                        │
    • 混淆 SQL 注入                      │                               │
    • 存储过程调用                       │                               │
         │                              │                               │
         ↓                              ↓                               │
  【最终结果】                      【最终结果】                           │
         │                              │                               │
    ModSecurity:                   Acra 透明代理:                        │
    TPR: 95.3-97.3%                延迟 +21-127%                         │
    FPR: 0.7-2.7%                  CPU +91-255%                          │
         │                              │                               │
    Suricata:                      pgcrypto 应用层:                      │
    TPR: 95.3-97.3%                延迟 +34-112%                         │
    FPR: 1.3-3.7%                  CPU +106-152%                         │
         │                              │                               │
         └──────────────────────────────┴───────────────────────────────┤
                                                                        │
                                                                        ↓
                                                          ┌─────────────────────────┐
                                                          │  生成报告文件            │
                                                          │  ─────────────────────  │
                                                          │  • attack_detection_    │
                                                          │    metrics.csv          │
                                                          │  • encryption_          │
                                                          │    benchmark.csv        │
                                                          │  • encryption_          │
                                                          │    benchmark.md         │
                                                          │  • CPU_SAMPLING_        │
                                                          │    SUCCESS.md           │
                                                          └─────────────────────────┘
                                                                        │
                                                                        ↓
                                                          ┌─────────────────────────┐
                                                          │   实验完成 ✓             │
                                                          └─────────────────────────┘
```

### 第一步: 测试环境准备

准备测试工具及其依赖环境. 首先安装 Docker 和 Docker Compose 作为容器编排工具, 确保主机系统满足资源要求 (至少 16 GB 内存, 8 vCPU). 下载实验代码仓库, 包含 Dockerfile, docker-compose.yml 配置文件以及测试脚本. 配置环境依赖, 包括构建 ModSecurity WAF 镜像 (基于 Nginx + OWASP CRS), Suricata IDS 镜像和攻击客户端镜像 (包含 SQLMap, Hydra 等工具). 通过 `docker compose build` 指令生成所有服务的容器镜像.

### 第二步: 容器化系统构建

构建分布式数据库安全测试网络. 使用 Docker Compose 定义 10 个服务容器, 包括 3 个 PostgreSQL 实例 (baseline, acra-backend, pgcrypto), 1 个 MongoDB 实例, 2 个防御系统 (ModSecurity, Suricata), 1 个漏洞应用后端, 1 个 Acra 透明加密代理, 1 个 Juice Shop 靶场和 1 个攻击客户端. 配置服务间依赖关系 (depends_on) 确保正确的启动顺序. 为每个服务分配资源配额 (数据库服务 4 vCPU/8 GB, 代理服务 2 vCPU/4 GB) 并设置网络端口映射. 通过 `docker compose up -d` 启动所有容器, 形成完整的测试网络拓扑.

### 第三步: 测试执行

进行两类实际测试: 攻击检测测试和加密性能测试.

**攻击检测测试**: 首先进行预测试, 验证 attack-client 能够正常访问 ModSecurity WAF (端口 8081), WAF 能够转发请求到 vuln-api, 以及 Suricata IDS 能够监听流量. 若预测试失败, 返回第二步检查网络配置和服务依赖. 预测试通过后, 执行 `automate_attacks.py` 脚本, 自动化执行三类 SQL 注入攻击 (基础注入, 混淆注入, 存储过程调用), 每类生成 150 个恶意请求和 150 个正常请求. 同时使用 Hydra 进行暴力破解测试. 测试期间持续监控 ModSecurity 审计日志和 Suricata eve.json 输出.

**加密性能测试**: 在主机环境运行 `benchmark_encryption.py` 脚本, 依次连接三个数据库环境 (baseline 端口 5433, acra-server 端口 9393, postgres-pgcrypto 端口 5435). 对每个环境执行 500 次写入, 500 次标准读取和 500 次可搜索查询操作. 测试期间使用独立线程调用 `docker stats` 以 0.3 秒间隔采样 CPU 利用率, 记录每次操作的响应延迟. 为消除缓存干扰, 每个环境测试前执行 `DROP TABLE` 清空数据.

### 第四步: 结果分析

统计分析各测试工具在不同场景下的效果.

**攻击检测分析**: 收集 ModSecurity 和 Suricata 的检测日志, 统计真阳性 (TP), 假阴性 (FN), 假阳性 (FP) 和真阴性 (TN) 数量. 计算威胁检测率 (TPR = TP / (TP + FN)) 和误报率 (FPR = FP / (FP + TN)). 执行 `detect_metrics.py` 脚本进行自动化去重和分类, 区分基础 SQL 注入, 混淆 SQL 注入和存储过程调用三类攻击的检测效果. 人工分析误报和漏报案例, 识别规则盲区和绕过技术. 最终生成 `attack_detection_metrics.csv` 报告, 展示 ModSecurity TPR 95.3-97.3%, FPR 0.7-2.7%; Suricata TPR 95.3-97.3%, FPR 1.3-3.7%.

**加密性能分析**: 收集基准环境和两个加密环境的延迟数据及 CPU 数据, 计算延迟开销百分比和 CPU 开销百分比. 需要注意 CPU 开销为相对增长率而非绝对使用率. 对 500 次操作的延迟数据计算平均值, 过滤异常值 (超过 3 倍标准差). 验证数据完整性, 确保 CPU 采样成功率达到 100% (12/12 测量点). 生成 `encryption_benchmark.csv` 原始数据表, `encryption_benchmark.md` 详细分析报告和 `CPU_SAMPLING_SUCCESS.md` 数据质量改进报告. 最终结论: Acra 写入延迟最优 (21.44%), pgcrypto 读取性能最优 (112% vs 127%), pgcrypto 可搜索查询压倒性优势 (-1.71%, 因未加密字段).

## 总结

此架构实现了两个独立的实验环境:

1. **攻击检测环境**: 完整的攻击-防御-检测链路
   - 攻击层: SQLMap, Hydra, 自定义脚本
   - 防御层: ModSecurity WAF, Suricata IDS
   - 目标层: 漏洞应用 + 数据库

2. **加密性能环境**: 三种数据库配置对比
   - Baseline: 未加密基准
   - Acra: 透明代理加密 (零代码改造)
   - pgcrypto: 应用层字段加密 (细粒度控制)

所有服务运行在同一 Docker 网络中, 通过服务名互相访问, 资源隔离但网络互通.
