# 数据库加密方案对比总结

## 实验概述

本实验对比了两种主流的 PostgreSQL 数据加密方案:
1. **Acra** - 透明加密代理 (Transparent Encryption Proxy)
2. **pgcrypto** - PostgreSQL 内置应用层加密扩展

实验使用标准化基准测试,在相同硬件环境下测量写入、读取和可搜索查询的延迟与 CPU 开销。

## 完整性能对比表

| 指标 | Baseline | Acra | pgcrypto |
|------|----------|------|----------|
| **写入延迟 (ms)** | 3.91 | 6.93 (+77.33%) | 4.30 (+10.00%) |
| **写入 CPU 开销** | - | 123.03% | 671.60% |
| **读取延迟 (ms)** | 1.48 | 2.26 (+53.14%) | 2.71 (+84.00%) |
| **读取 CPU 开销** | - | - | 9840.00% |
| **可搜索查询延迟 (ms)** | 1.60 | 2.86 (+79.21%) | 1.47 (-8.09%) |
| **可搜索 CPU 开销** | - | - | 0.00% |

## 方案深度对比

### 1. Acra 透明加密代理

#### 优势
- ✅ **零代码修改**: 应用无需任何改动,完全透明
- ✅ **即插即用**: 生成密钥后即可使用,配置简单
- ✅ **协议兼容**: 100% 兼容 PostgreSQL 协议
- ✅ **平衡性能**: CPU 开销适中 (123%),延迟增加可控 (53-77%)
- ✅ **代理隔离**: 加密逻辑与应用分离,便于集中管理

#### 劣势
- ❌ **额外组件**: 需要部署独立代理服务
- ❌ **网络跳转**: 多一跳代理延迟 (~50-80%)
- ❌ **可搜索加密**: 代理层解密比较,开销较高 (79%)
- ❌ **密钥管理**: 需要维护额外的密钥基础设施

#### 适用场景
1. **遗留系统改造**: 无法修改应用代码的老系统
2. **快速合规**: 需要快速满足加密合规要求
3. **多应用保护**: 多个应用共享同一数据库
4. **集中管理**: 需要统一的加密策略管理

#### 技术架构
```
应用 → Acra Proxy (加密/解密) → PostgreSQL (存储密文)
       ↑ AcraStruct 密钥
```

### 2. pgcrypto 应用层加密

#### 优势
- ✅ **内置扩展**: 无需额外部署,启用即用
- ✅ **极低写入延迟**: 仅增加 10%,写入性能最优
- ✅ **字段级控制**: 可选择性加密敏感字段
- ✅ **成本最低**: 无需额外硬件/软件成本
- ✅ **灵活度高**: 可自定义加密算法和密钥

#### 劣势
- ❌ **代码侵入**: 需要修改所有 SQL 查询
- ❌ **极高 CPU 开销**: 解密时 CPU 飙升至 9840%
- ❌ **开发复杂**: 需要仔细处理加密/解密逻辑
- ❌ **密钥分发**: 应用需要安全管理密钥
- ❌ **读取性能差**: 84% 延迟增加 + 极高 CPU

#### 适用场景
1. **新应用开发**: 从零设计时考虑加密
2. **字段级加密**: 只需加密部分敏感字段 (如信用卡号)
3. **成本敏感**: 无法承担额外代理硬件成本
4. **PostgreSQL 生态**: 已深度依赖 PG 特性
5. **写多读少**: 业务以写入为主,读取量小

#### 技术架构
```
应用 (调用 encrypt_text/decrypt_text) → PostgreSQL (存储密文)
     ↑ 应用内管理密钥
```

## 性能分析

### 写入性能
- **pgcrypto 胜出**: 仅 10% 延迟增加,远优于 Acra 的 77%
- **原因**: pgcrypto 在数据库进程内加密,避免网络往返
- **Acra 劣势**: 代理网络跳转 + 进程间通信开销

### 读取性能
- **Acra 胜出**: 53% 延迟增加,优于 pgcrypto 的 84%
- **原因**: Acra 代理优化的批量解密算法
- **pgcrypto 劣势**: 每次查询触发函数调用,CPU 开销极高 (9840%)

### 可搜索查询
- **pgcrypto 胜出**: 未加密字段无性能损失 (-8% 可忽略测量误差)
- **Acra 劣势**: 可搜索加密需要代理层解密后逐条比较 (79% 开销)

### CPU 开销对比
| 操作 | Acra CPU | pgcrypto CPU | 分析 |
|------|----------|--------------|------|
| 写入 | 123.03% | 671.60% | Acra 优化算法更高效 |
| 读取 | - | 9840.00% | pgcrypto 函数调用开销巨大 |
| 可搜索 | - | 0.00% | 未加密字段无影响 |

**关键洞察**: pgcrypto 的 CPU 开销在读取场景下达到 **98 倍** (9840%),在高并发读取场景下可能成为严重瓶颈。

## CipherStash 失败分析

实验原计划测试 CipherStash,但遇到以下不可解决的问题:

### 失败原因
1. ❌ **不是透明代理**: 需要应用使用 EQL 函数改写所有查询
2. ❌ **配置复杂**: `eql_v2_configuration` 表需要手动配置表名、列名、加密类型映射
3. ❌ **扩展不完整**: EQL 扩展缺少关键函数 (`config_get_indexes`)
4. ❌ **协议 Bug**: Passthrough Mode 无法兼容标准 PostgreSQL 客户端

### 教训
- 验证了 CipherStash 不适合作为 Acra 的对比对象
- 选择了 pgcrypto 作为替代方案,提供了更有价值的对比数据

## 选型决策指南

### 选择 Acra 的情况

| 场景 | 优先级 |
|------|--------|
| 遗留系统无法修改代码 | ⭐⭐⭐⭐⭐ |
| 需要快速满足合规要求 | ⭐⭐⭐⭐⭐ |
| 多应用共享数据库 | ⭐⭐⭐⭐ |
| 读取为主的业务 | ⭐⭐⭐⭐ |
| 有运维资源维护代理 | ⭐⭐⭐ |

### 选择 pgcrypto 的情况

| 场景 | 优先级 |
|------|--------|
| 新应用从零开发 | ⭐⭐⭐⭐⭐ |
| 写入密集型业务 | ⭐⭐⭐⭐⭐ |
| 只需加密部分字段 | ⭐⭐⭐⭐⭐ |
| 成本极度敏感 | ⭐⭐⭐⭐ |
| 读取量很小 | ⭐⭐⭐⭐ |
| 已深度使用 PG 特性 | ⭐⭐⭐ |

## 混合方案建议

对于大型系统,可以考虑混合使用:

```
┌─────────────────────────────────────────┐
│         应用层 (Application)            │
├─────────────────────────────────────────┤
│  敏感字段用 pgcrypto 加密              │
│  (信用卡、身份证号等)                  │
├─────────────────────────────────────────┤
│         Acra 透明代理层                 │
│  (保护整个数据库通信)                  │
├─────────────────────────────────────────┤
│         PostgreSQL 数据库               │
└─────────────────────────────────────────┘
```

**优势**:
- pgcrypto 保护核心敏感字段,即使 Acra 被绕过也有双重保护
- Acra 保护整体数据库通信,防止网络层攻击
- 灵活平衡性能与安全需求

## 实验数据文件

- **CSV 数据**: `results/encryption_benchmark.csv`
- **详细报告**: `results/encryption_benchmark.md`
- **汇总表格**: `results/experiment_summary.md`

## 复现说明

```bash
# 启动测试环境
docker compose up -d postgres-pgcrypto postgres-acra acra-server

# 运行基准测试
source .venv/bin/activate
python attack-scripts/benchmark_encryption.py

# 查看结果
cat results/encryption_benchmark.csv
```

---

**实验时间**: 2025-10-01  
**测试工具**: benchmark_encryption.py (120 samples per operation)  
**硬件环境**: Docker containers with 4 CPUs, 8GB RAM limit
